// 1. Cấu hình Generator & Datasource
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 2. Định nghĩa Enums (Dựa trên description.md)
enum TenantStatus {
  DRAFT
  ACTIVE
  SUSPENDED
}

enum UserRole {
  OWNER
  STAFF
  KITCHEN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING
  LOCKED
}

// 3. Model TENANT
model Tenant {
  id             String       @id @default(uuid()) // PK là UUID
  name           String
  slug           String       @unique              // Slug phải unique để làm subdomain/url
  status         TenantStatus @default(DRAFT)      // Mặc định là DRAFT khi mới đăng ký bước 1
  
  // Dữ liệu JSON không cấu trúc cứng, phù hợp cho settings linh động
  settings       Json?        @default("{}") 
  openingHours   Json?        @map("opening_hours") // Map sang column snake_case
  
  onboardingStep Int          @default(1) @map("onboarding_step")

  // Timestamps tiêu chuẩn
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  // Relations (Quan hệ ngược)
  users          User[]
  // paymentConfig TenantPaymentConfig? (Sẽ thêm ở Epic sau)
  
  @@map("tenants") // Tên bảng trong DB là số nhiều 'tenants'
}

// 4. Model USER
model User {
  id           String     @id @default(uuid())
  email        String     @unique
  passwordHash String     @map("password_hash")
  fullName     String     @map("full_name")
  
  role         UserRole   @default(STAFF)
  status       UserStatus @default(PENDING) // Pending cho đến khi verify email/admin duyệt

  // Foreign Key: Tenant
  tenantId     String     @map("tenant_id")
  tenant       Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  // Relations
  sessions     UserSession[]

  @@map("users")
  // Index để tăng tốc query tìm user theo email trong tenant (Multitenancy)
  @@index([tenantId, email]) 
}

// 5. Model USER_SESSION (Quản lý phiên đăng nhập)
model UserSession {
  id               String   @id @default(uuid())
  
  // Foreign Key: User
  userId           String   @map("user_id")
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  refreshTokenHash String   @map("refresh_token_hash") // Chỉ lưu hash, không lưu plain token
  deviceInfo       String?  @map("device_info")        // Chrome on Mac, v.v.
  
  lastUsedAt       DateTime @default(now()) @map("last_used_at")
  expiresAt        DateTime @map("expires_at")
  
  createdAt        DateTime @default(now()) @map("created_at")

  @@map("user_sessions")
}