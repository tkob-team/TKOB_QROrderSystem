// 1. Cấu hình Generator & Datasource
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 2. Định nghĩa Enums (Dựa trên description.md)
enum TenantStatus {
  DRAFT
  ACTIVE
  SUSPENDED
}

enum UserRole {
  OWNER
  STAFF
  KITCHEN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING
  LOCKED
}

enum MenuItemStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ModifierType {
  SINGLE_CHOICE // Radio: chọn 1 (Size: S/M/L)
  MULTI_CHOICE // Checkbox: chọn nhiều (Toppings)
}

enum TableStatus {
  AVAILABLE // Bàn trống, sẵn sàng phục vụ
  OCCUPIED // Đang có khách
  RESERVED // Đã đặt trước
  INACTIVE // Tạm ngưng sử dụng (bảo trì, etc.)
}

enum OrderStatus {
  PENDING // Waiting for payment confirmation
  RECEIVED // Order received (either paid or bill-to-table)
  PREPARING // Kitchen is preparing
  READY // Ready to serve
  SERVED // Delivered to table
  COMPLETED // Customer finished, ready to pay (bill-to-table)
  PAID // Payment completed
  CANCELLED // Order cancelled
}

enum PaymentMethod {
  BILL_TO_TABLE // Pay at table after eating (default for Vietnam)
  SEPAY_QR // SePay QR Banking (VietQR)
  CARD_ONLINE // Pay online via Stripe (future)
  CASH // Cash payment (recorded by staff)
}

enum PaymentStatus {
  PENDING // Waiting for payment
  PROCESSING // Payment being processed
  COMPLETED // Payment successful
  FAILED // Payment failed
  REFUNDED // Payment refunded
}

enum OrderPriority {
  NORMAL
  HIGH // Đã quá thời gian chuẩn
  URGENT // Đã quá thời gian ngưỡng
}

enum PromotionType {
  PERCENTAGE // Giảm theo % (e.g., 20%)
  FIXED // Giảm số tiền cố định (e.g., 50,000 VND)
}

// 3. Model TENANT
model Tenant {
  id     String       @id @default(uuid()) // PK là UUID
  name   String
  slug   String       @unique // Slug phải unique để làm subdomain/url
  status TenantStatus @default(DRAFT) // Mặc định là DRAFT khi mới đăng ký bước 1

  // Dữ liệu JSON không cấu trúc cứng, phù hợp cho settings linh động
  settings     Json? @default("{}")
  openingHours Json? @map("opening_hours") // Map sang column snake_case

  onboardingStep Int @default(1) @map("onboarding_step")

  // Timestamps tiêu chuẩn
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations (Quan hệ ngược)
  users            User[]
  paymentConfig    TenantPaymentConfig?
  menuItems        MenuItem[]
  modifierGroups   ModifierGroup[]
  menuCategories   MenuCategory[]
  tables           Table[] // Relation to Table model
  orders           Order[]
  carts            Cart[] // Cart relation
  payments         Payment[] // Payment relation
  staffInvitations StaffInvitation[] // Staff invitations
  promotions       Promotion[] // Promotion codes
  subscription     TenantSubscription? // Subscription relation
  bills            Bill[] // Bill relation

  @@map("tenants") // Tên bảng trong DB là số nhiều 'tenants'
}

// 4. Model USER
model User {
  id           String  @id @default(uuid())
  email        String  @unique
  passwordHash String  @map("password_hash")
  fullName     String  @map("full_name")
  avatarUrl    String? @map("avatar_url") // User profile avatar URL

  role   UserRole   @default(STAFF)
  status UserStatus @default(PENDING) // Pending cho đến khi verify email/admin duyệt

  // Foreign Key: Tenant
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  sessions UserSession[]

  // Index để tăng tốc query tìm user theo email trong tenant (Multitenancy)
  @@index([tenantId, email])
  @@map("users")
}

// 5. Model USER_SESSION (Quản lý phiên đăng nhập)
model UserSession {
  id String @id @default(uuid())

  // Foreign Key: User
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  refreshTokenHash String  @map("refresh_token_hash") // Chỉ lưu hash, không lưu plain token
  deviceInfo       String? @map("device_info") // Chrome on Mac, v.v.

  lastUsedAt DateTime @default(now()) @map("last_used_at")
  expiresAt  DateTime @map("expires_at")

  createdAt DateTime @default(now()) @map("created_at")

  @@map("user_sessions")
}

// Staff Invitation (Lời mời nhân viên)
model StaffInvitation {
  id        String    @id @default(uuid())
  tenantId  String    @map("tenant_id")
  email     String // Email người được mời
  role      UserRole  @default(STAFF) // Role được assign
  token     String    @unique // Token để accept invite
  expiresAt DateTime  @map("expires_at") // Hết hạn sau 7 ngày
  usedAt    DateTime? @map("used_at") // Đánh dấu đã sử dụng
  invitedBy String    @map("invited_by") // User ID người mời

  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, email])
  @@index([token])
  @@map("staff_invitations")
}

// 6. Model TENANT_PAYMENT_CONFIG
model TenantPaymentConfig {
  id       String @id @default(uuid())
  tenantId String @unique @map("tenant_id")

  // SePay Config
  sepayEnabled     Boolean @default(false) @map("sepay_enabled")
  sepayApiKey      String? @map("sepay_api_key") // Encrypted
  sepayAccountNo   String? @map("sepay_account_no")
  sepayAccountName String? @map("sepay_account_name")
  sepayBankCode    String? @map("sepay_bank_code") // e.g., "MB", "VCB", "ACB"

  // Webhook (optional)
  webhookSecret  String? @map("webhook_secret")
  webhookEnabled Boolean @default(false) @map("webhook_enabled")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_payment_configs")
}

// Menu Category (Danh mục món ăn)
model MenuCategory {
  id           String   @id @default(uuid())
  name         String // "Appetizers", "Main Courses", "Desserts"
  tenantId     String   @map("tenant_id")
  description  String?
  displayOrder Int      @default(0) @map("display_order") // Thứ tự hiển thị
  active       Boolean  @default(true) // Bật/tắt category
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  menuItems MenuItem[]

  @@unique([name, tenantId], name: "menu_category_tenant_name_unique")
  @@index([tenantId, active])
  @@index([tenantId, displayOrder])
  @@map("menu_categories")
}

// Menu Item (Món ăn)
model MenuItem {
  id              String         @id @default(uuid())
  tenantId        String         @map("tenant_id")
  categoryId      String         @map("category_id")
  name            String
  description     String?
  price           Decimal        @db.Decimal(10, 2) // Giá cơ bản
  imageUrl        String?        @map("image_url") // Deprecated, use photos instead
  status          MenuItemStatus @default(DRAFT) // DRAFT | PUBLISHED | ARCHIVED
  available       Boolean        @default(true) // Còn hàng hay không
  displayOrder    Int            @default(0) @map("display_order")
  preparationTime Int?           @map("preparation_time") // Minutes (0-240)
  chefRecommended Boolean        @default(false) @map("chef_recommended")
  popularity      Int            @default(0) // Cached counter for sorting
  primaryPhotoId  String?        @map("primary_photo_id") // Reference to primary photo

  // JSON fields for flexible data
  tags      Json? @default("[]") // ["popular", "spicy", "vegetarian"]
  allergens Json? @default("[]") // ["nuts", "gluten", "dairy"]

  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  publishedAt DateTime? @map("published_at")

  // Relations
  tenant         Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  category       MenuCategory       @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  modifierGroups MenuItemModifier[] // Many-to-Many với ModifierGroup
  photos         MenuItemPhoto[]    @relation("MenuItemPhotos")
  orderItems     OrderItem[]
  cartItems      CartItem[] // Cart items relation

  @@unique([name, tenantId, categoryId], name: "menu_items_name_tenant_category_unique")
  @@index([tenantId, status, available])
  @@index([tenantId, categoryId])
  @@index([tenantId, popularity]) // Index for popularity sorting
  @@index([tenantId, chefRecommended]) // Index for chef recommendations
  @@map("menu_items")
}

model MenuItemPhoto {
  id           String  @id @default(uuid())
  menuItemId   String  @map("menu_item_id")
  url          String // Full URL to image (e.g., S3, Cloudinary)
  filename     String // Original filename (sanitized)
  mimeType     String  @map("mime_type") // image/jpeg, image/png, image/webp
  size         Int // File size in bytes
  width        Int? // Image width in pixels
  height       Int? // Image height in pixels
  displayOrder Int     @default(0) @map("display_order")
  isPrimary    Boolean @default(false) @map("is_primary") // Only one primary per item

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  menuItem MenuItem @relation("MenuItemPhotos", fields: [menuItemId], references: [id], onDelete: Cascade)

  @@index([menuItemId])
  @@index([menuItemId, isPrimary]) // Fast lookup for primary photo
  @@map("menu_item_photos")
}

// Modifier Group (Nhóm tuỳ chọn: Size, Extras, Toppings)
model ModifierGroup {
  id           String       @id @default(uuid())
  tenantId     String       @map("tenant_id")
  name         String // "Size", "Extra Toppings", "Spice Level"
  description  String?
  type         ModifierType // SINGLE_CHOICE | MULTI_CHOICE
  required     Boolean      @default(false) // Bắt buộc chọn không?
  minChoices   Int          @default(0) @map("min_choices") // Min số lựa chọn (với MULTI_CHOICE)
  maxChoices   Int?         @map("max_choices") // Max số lựa chọn (null = unlimited)
  displayOrder Int          @default(0) @map("display_order")
  active       Boolean      @default(true)
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  // Relations
  tenant    Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  options   ModifierOption[]
  menuItems MenuItemModifier[] // Many-to-Many với MenuItem

  @@index([tenantId, active])
  @@map("modifier_groups")
}

// Modifier Option (Các lựa chọn cụ thể trong nhóm)
model ModifierOption {
  id           String   @id @default(uuid())
  groupId      String   @map("group_id")
  name         String // "Small", "Medium", "Large", "Extra Cheese"
  priceDelta   Decimal  @default(0) @map("price_delta") @db.Decimal(10, 2) // Giá thêm/bớt
  displayOrder Int      @default(0) @map("display_order")
  active       Boolean  @default(true)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  group ModifierGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([groupId, active])
  @@map("modifier_options")
}

// Junction Table: MenuItem <-> ModifierGroup (Many-to-Many)
model MenuItemModifier {
  menuItemId      String   @map("menu_item_id")
  modifierGroupId String   @map("modifier_group_id")
  displayOrder    Int      @default(0) @map("display_order") // Thứ tự hiển thị modifier trong item
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  menuItem      MenuItem      @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  modifierGroup ModifierGroup @relation(fields: [modifierGroupId], references: [id], onDelete: Cascade)

  @@id([menuItemId, modifierGroupId])
  @@index([menuItemId])
  @@index([modifierGroupId])
  @@map("menu_item_modifiers")
}

// Table (Bàn ăn)
model Table {
  id          String      @id @default(uuid())
  tenantId    String      @map("tenant_id")
  tableNumber String      @map("table_number") // "Table 1", "A1", "VIP-01"
  capacity    Int         @default(4) // Số người ngồi tối đa (1-20)
  location    String? // "Main Hall", "Terrace", "Floor 2"
  description String? // Optional description
  status      TableStatus @default(AVAILABLE) // AVAILABLE | OCCUPIED | RESERVED | INACTIVE

  // QR Code fields (enhanced security)
  qrToken          String?   @unique @map("qr_token") // HMAC signed token (unique globally)
  qrTokenHash      String?   @map("qr_token_hash") // SHA256 hash for validation
  qrTokenCreatedAt DateTime? @map("qr_token_created_at") // Thời điểm tạo QR
  qrInvalidatedAt  DateTime? @map("qr_invalidated_at") // Thời điểm invalidate (when regenerated)

  // Session management (Haidilao style)
  currentSessionId String? @map("current_session_id") // Active session ID

  // Metadata
  displayOrder Int     @default(0) @map("display_order")
  active       Boolean @default(true) // Soft delete flag

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant   Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sessions TableSession[] // One table can have many sessions (history)
  orders   Order[]
  carts    Cart[] // Cart relation
  bills    Bill[] // Bill relation

  @@unique([tableNumber, tenantId], name: "table_number_tenant_unique")
  @@index([tenantId, status])
  @@index([tenantId, active])
  @@index([qrToken]) // Fast QR lookup
  @@index([currentSessionId]) // Fast session lookup
  @@map("tables")
}

// TableSession - Quản lý phiên sử dụng bàn (Haidilao style)
model TableSession {
  id       String @id @default(uuid())
  tableId  String @map("table_id")
  tenantId String @map("tenant_id")

  // Session lifecycle
  scannedAt DateTime @default(now()) @map("scanned_at")
  active    Boolean  @default(true)

  // Cleared by staff (staff control when table is free)
  clearedAt DateTime? @map("cleared_at")
  clearedBy String?   @map("cleared_by") // Staff user ID

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  table Table @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@index([tableId, active])
  @@index([tenantId, active])
  @@index([active, createdAt]) // For querying active sessions
  @@map("table_sessions")
}

// Order (Main order entity)
model Order {
  id          String  @id @default(uuid())
  orderNumber String  @map("order_number") // "ORD-20250102-0001"
  tenantId    String  @map("tenant_id")
  tableId     String  @map("table_id")
  sessionId   String? @map("session_id") // Link to TableSession

  // Customer info
  customerName  String? @map("customer_name")
  customerNotes String? @map("customer_notes") @db.Text

  // Order details
  status        OrderStatus   @default(PENDING)
  priority      OrderPriority @default(NORMAL)
  subtotal      Decimal       @db.Decimal(10, 2)
  tax           Decimal       @default(0) @db.Decimal(10, 2)
  serviceCharge Decimal       @default(0) @map("service_charge") @db.Decimal(10, 2) // Service charge amount
  tip           Decimal       @default(0) @db.Decimal(10, 2) // Tip amount
  total         Decimal       @db.Decimal(10, 2)

  estimatedPrepTime Int? @map("estimated_prep_time") // Estimated time in minutes
  actualPrepTime    Int? @map("actual_prep_time") // Actual time taken in minutes

  // Payment
  paymentMethod PaymentMethod @default(BILL_TO_TABLE) @map("payment_method")
  paymentStatus PaymentStatus @default(PENDING) @map("payment_status")
  paidAt        DateTime?     @map("paid_at")

  // Bill reference (when orders are grouped for payment)
  billId String? @map("bill_id")
  bill   Bill?   @relation(fields: [billId], references: [id], onDelete: SetNull)

  // // Stripe payment (if applicable)
  // stripePaymentIntentId String? @map("stripe_payment_intent_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Metadata & Timestamps for KDS
  receivedAt  DateTime? @map("received_at") // When status changed to RECEIVED
  preparingAt DateTime? @map("preparing_at") // When status changed to PREPARING
  readyAt     DateTime? @map("ready_at") // When status changed to READY
  servedAt    DateTime? @map("served_at")
  completedAt DateTime? @map("completed_at")

  // Relations
  tenant        Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  table         Table                @relation(fields: [tableId], references: [id], onDelete: Restrict)
  items         OrderItem[]
  statusHistory OrderStatusHistory[]
  payment       Payment? // Optional payment for online orders

  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@index([tableId, status])
  @@index([orderNumber])
  @@index([sessionId])
  @@map("orders")
}

// Order Item (Line item with modifiers)
model OrderItem {
  id         String @id @default(uuid())
  orderId    String @map("order_id")
  menuItemId String @map("menu_item_id")

  // Snapshot of menu item at order time
  name     String
  price    Decimal @db.Decimal(10, 2)
  quantity Int     @default(1)

  // Modifiers selected (JSON array)
  modifiers Json? @default("[]") // [{ groupId, groupName, optionId, optionName, priceDelta }]

  // Calculated prices
  itemTotal Decimal @map("item_total") @db.Decimal(10, 2) // (price + modifiers) * quantity

  // Special instructions
  notes String? @db.Text

  // Kitchen status
  prepared   Boolean   @default(false) // Đã chế biến xong chưa (for KDS)
  preparedAt DateTime? @map("prepared_at") // Thời điểm hoàn thành món này

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  order    Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItem MenuItem    @relation(fields: [menuItemId], references: [id], onDelete: Restrict)
  review   ItemReview? // One review per order item

  @@index([orderId])
  @@index([menuItemId])
  @@index([orderId, prepared])
  @@map("order_items")
}

// Order Status History (Audit trail)
model OrderStatusHistory {
  id        String      @id @default(uuid())
  orderId   String      @map("order_id")
  status    OrderStatus
  notes     String?     @db.Text
  changedBy String?     @map("changed_by") // User ID (staff)
  createdAt DateTime    @default(now()) @map("created_at")

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId, createdAt])
  @@map("order_status_history")
}

// Cart (Shopping cart for persistent cart feature)
model Cart {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  tableId   String   @map("table_id")
  sessionId String?  @map("session_id") // Optional session tracking
  expiresAt DateTime @map("expires_at") // Auto-expire after 1 hour

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  table  Table      @relation(fields: [tableId], references: [id], onDelete: Cascade)
  items  CartItem[]

  @@unique([tableId, sessionId])
  @@index([expiresAt]) // For cleanup queries
  @@index([tenantId, createdAt])
  @@map("carts")
}

// Cart Item (Items in shopping cart)
model CartItem {
  id         String  @id @default(uuid())
  cartId     String  @map("cart_id")
  menuItemId String  @map("menu_item_id")
  quantity   Int     @default(1)
  unitPrice  Decimal @map("unit_price") @db.Decimal(10, 2)
  notes      String? @db.Text
  modifiers  Json?   @default("[]") // [{ groupId, optionId, name, priceDelta }]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  cart     Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  menuItem MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  @@index([cartId])
  @@index([menuItemId])
  @@map("cart_items")
}

// Payment (Online payment transactions)
model Payment {
  id       String        @id @default(uuid())
  orderId  String?       @unique @map("order_id") // Optional for subscription payments
  tenantId String        @map("tenant_id")
  method   PaymentMethod
  status   PaymentStatus @default(PENDING)

  // Amount
  amount   Decimal @db.Decimal(10, 2)
  currency String  @default("VND")

  // SePay specific fields
  transactionId   String? @map("transaction_id") // SePay transaction ID
  bankCode        String? @map("bank_code") // Bank code (VCB, TCB, etc.)
  accountNumber   String? @map("account_number") // Merchant account receiving payment
  qrContent       String? @map("qr_content") @db.Text // QR code data for VietQR
  deepLink        String? @map("deep_link") @db.Text // Deep link to banking app
  transferContent String? @map("transfer_content") // Transfer description/code

  // Provider metadata
  providerData Json? @map("provider_data") // Raw webhook data from SePay

  // Status tracking
  failureReason String?   @map("failure_reason")
  paidAt        DateTime? @map("paid_at")
  refundedAt    DateTime? @map("refunded_at")
  expiresAt     DateTime  @map("expires_at") // Payment link expires after 15 minutes

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  order  Order? @relation(fields: [orderId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, status])
  @@index([transactionId])
  @@index([expiresAt])
  @@map("payments")
}

// Item Review (Customer ratings for order items)
model ItemReview {
  id          String  @id @default(uuid())
  orderItemId String  @map("order_item_id")
  sessionId   String  @map("session_id")
  tenantId    String  @map("tenant_id")
  rating      Int // 1-5 stars
  comment     String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  orderItem OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@unique([orderItemId]) // One review per order item
  @@index([sessionId])
  @@index([tenantId, createdAt])
  @@map("item_reviews")
}

// Promotion/Voucher (Mã giảm giá)
model Promotion {
  id          String        @id @default(uuid())
  tenantId    String        @map("tenant_id")
  code        String // "SUMMER20", "WELCOME10"
  description String?
  type        PromotionType // PERCENTAGE or FIXED

  value         Decimal  @db.Decimal(10, 2) // 20 for 20%, 50000 for 50k VND
  minOrderValue Decimal? @map("min_order_value") @db.Decimal(10, 2) // Minimum order to apply
  maxDiscount   Decimal? @map("max_discount") @db.Decimal(10, 2) // Cap for percentage discounts

  usageLimit Int? @map("usage_limit") // Max total uses (null = unlimited)
  usageCount Int  @default(0) @map("usage_count") // Current usage count

  startsAt  DateTime @map("starts_at")
  expiresAt DateTime @map("expires_at")
  active    Boolean  @default(true)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, code]) // Code unique per tenant
  @@index([tenantId, active])
  @@index([code])
  @@map("promotions")
}

// ================================================
// SUBSCRIPTION SYSTEM
// ================================================

enum SubscriptionTier {
  FREE // Free forever with limits
  BASIC // Paid tier with higher limits
  PREMIUM // Unlimited tier
}

enum SubscriptionStatus {
  ACTIVE // Currently active
  EXPIRED // Payment not renewed
  CANCELLED // User cancelled
}

// Subscription Plans - DB-driven pricing (can change without deploy)
model SubscriptionPlan {
  id   String           @id @default(uuid())
  tier SubscriptionTier @unique // FREE, BASIC, PREMIUM

  // Pricing (DB-driven, can be updated)
  priceUSD Decimal @default(0) @map("price_usd") @db.Decimal(10, 2) // Monthly price in USD
  priceVND Decimal @default(0) @map("price_vnd") @db.Decimal(12, 0) // Monthly price in VND

  // Limits (-1 = unlimited)
  maxTables      Int @default(1) @map("max_tables") // Max tables allowed
  maxMenuItems   Int @default(10) @map("max_menu_items") // Max menu items
  maxOrdersMonth Int @default(100) @map("max_orders_month") // Max orders per month
  maxStaff       Int @default(1) @map("max_staff") // Max staff members

  // Features (JSON for flexibility)
  features Json @default("{}") // { "analytics": false, "promotions": false, "customBranding": false }

  // Display
  name        String // "Free", "Basic", "Premium"
  description String? // "Perfect for small restaurants"

  // Metadata
  isActive  Boolean  @default(true) @map("is_active") // Can disable a plan
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  subscriptions TenantSubscription[]

  @@map("subscription_plans")
}

// Tenant's active subscription
model TenantSubscription {
  id       String @id @default(uuid())
  tenantId String @unique @map("tenant_id")
  planId   String @map("plan_id")

  // Status
  status SubscriptionStatus @default(ACTIVE)

  // Billing cycle
  currentPeriodStart DateTime  @map("current_period_start")
  currentPeriodEnd   DateTime? @map("current_period_end") // null for FREE (never expires)

  // Usage tracking (reset monthly)
  ordersThisMonth Int      @default(0) @map("orders_this_month")
  usageResetAt    DateTime @default(now()) @map("usage_reset_at") // Last reset date

  // Payment history reference
  lastPaymentId String? @map("last_payment_id") // Reference to payment for upgrade

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan   SubscriptionPlan @relation(fields: [planId], references: [id])

  @@index([tenantId])
  @@index([planId])
  @@index([status])
  @@map("tenant_subscriptions")
}

// Bill/Invoice for grouping multiple orders when closing table
model Bill {
  id         String @id @default(uuid())
  billNumber String @unique @map("bill_number") // "BILL-20260118-0001"
  tenantId   String @map("tenant_id")
  tableId    String @map("table_id")
  sessionId  String @map("session_id")

  // Aggregated amounts from orders
  subtotal      Decimal @db.Decimal(10, 2) // Sum of all orders' totals
  discount      Decimal @default(0) @db.Decimal(10, 2) // Bill-level discount
  tip           Decimal @default(0) @db.Decimal(10, 2) // Bill-level tip
  serviceCharge Decimal @default(0) @map("service_charge") @db.Decimal(10, 2)
  tax           Decimal @default(0) @db.Decimal(10, 2)
  total         Decimal @db.Decimal(10, 2) // Final amount after discount/tip

  // Payment
  paymentMethod PaymentMethod @default(BILL_TO_TABLE) @map("payment_method")
  paymentStatus PaymentStatus @default(PENDING) @map("payment_status")
  paidAt        DateTime?     @map("paid_at")

  // Metadata
  notes     String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  table  Table   @relation(fields: [tableId], references: [id], onDelete: Restrict)
  orders Order[] // All orders included in this bill

  @@index([tenantId])
  @@index([tableId])
  @@index([sessionId])
  @@index([billNumber])
  @@map("bills")
}
